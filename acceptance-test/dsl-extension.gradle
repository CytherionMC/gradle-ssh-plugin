
feature('adding remote file assertion feature') {
    task 'extendRemoteFileAssertion'
    category 'test'
}

class RemoteFileAssertion {
    def assertFileContains(String path, String regexp) {
        execute("egrep '$regexp' '$path'")
    }
}

task extendRemoteFileAssertion << {
    def x = randomInt()
    def pathX = remoteTempPath('X')
    ssh.run {
        settings {
            extensions.add RemoteFileAssertion
        }
        session(remotes.localhost) {
            execute "echo 'port $x' > $pathX"
            assertFileContains pathX, "port $x"
        }
    }
}
