
remotes {
    gw1 {
        host = System.getenv('INTEGRATION_TEST_SSH_HOST') ?: 'localhost'
        user = System.getenv('INTEGRATION_TEST_SSH_USER') ?: System.getProperty('user.name')
        identity = file("${System.getProperty('user.home')}/.ssh/id_rsa")
    }
    gw2 {
        host = System.getenv('INTEGRATION_TEST_SSH_HOST') ?: 'localhost'
        user = System.getenv('INTEGRATION_TEST_SSH_USER') ?: System.getProperty('user.name')
        identity = file("${System.getProperty('user.home')}/.ssh/id_rsa")
        gateway = remotes.gw1
        knownHosts = allowAnyHosts
    }
    viaGateway {
        host = System.getenv('INTEGRATION_TEST_SSH_HOST') ?: 'localhost'
        user = System.getenv('INTEGRATION_TEST_SSH_USER') ?: System.getProperty('user.name')
        identity = file("${System.getProperty('user.home')}/.ssh/id_rsa")
        gateway = remotes.gw2
        knownHosts = allowAnyHosts
    }
}


task('should connect to the remote host via gateways') << {
    def x = randomInt()
    def y = randomInt()
    assert ssh.run {
        session(remotes.viaGateway) {
            execute "expr $x + $y"
        }
    } as int == (x + y)
}
